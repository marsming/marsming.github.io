<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="hive,">










<meta name="description" content="hive基本命令1. hive完整DDL1.1创建表CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name   [(col_name data_type [COMMENT col_comment], …)] [COMMENT table_comment] [PARTITIONED BY (col_name data_type [COMMENT col_">
<meta name="keywords" content="hive">
<meta property="og:type" content="article">
<meta property="og:title" content="hive基本命令（三）">
<meta property="og:url" content="http://marsm.top/hive/2018/03/10/hive基本命令（三）/index.html">
<meta property="og:site_name" content="Marsm">
<meta property="og:description" content="hive基本命令1. hive完整DDL1.1创建表CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name   [(col_name data_type [COMMENT col_comment], …)] [COMMENT table_comment] [PARTITIONED BY (col_name data_type [COMMENT col_">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-03-16T08:16:20.255Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hive基本命令（三）">
<meta name="twitter:description" content="hive基本命令1. hive完整DDL1.1创建表CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name   [(col_name data_type [COMMENT col_comment], …)] [COMMENT table_comment] [PARTITIONED BY (col_name data_type [COMMENT col_">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://marsm.top/hive/2018/03/10/hive基本命令（三）/">





  <title>hive基本命令（三） | Marsm</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?78fc6121aab1cdc163ad11bea6fa7076";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Marsm</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life is short, you need Python</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首&emsp;&emsp;页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标&emsp;&emsp;签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分&emsp;&emsp;类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归&emsp;&emsp;档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜&emsp;&emsp;索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://marsm.top/hive/2018/03/10/hive基本命令（三）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Marsm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marsm">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">hive基本命令（三）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-10T19:53:05+08:00">
                2018-03-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-03-16T16:16:20+08:00">
                2018-03-16
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/hive/" itemprop="url" rel="index">
                    <span itemprop="name">hive</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/hive/2018/03/10/hive基本命令（三）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/hive/2018/03/10/hive基本命令（三）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/hive/2018/03/10/hive基本命令（三）/" class="leancloud_visitors" data-flag-title="hive基本命令（三）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
				 <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="hive基本命令"><a href="#hive基本命令" class="headerlink" title="hive基本命令"></a>hive基本命令</h1><h2 id="1-hive完整DDL"><a href="#1-hive完整DDL" class="headerlink" title="1. hive完整DDL"></a>1. hive完整DDL</h2><h3 id="1-1创建表"><a href="#1-1创建表" class="headerlink" title="1.1创建表"></a>1.1创建表</h3><p>CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name</p>
<blockquote>
<p> [(col_name data_type [COMMENT col_comment], …)]<br> [COMMENT table_comment]<br> [PARTITIONED BY (col_name data_type [COMMENT col_comment], …)]<br> [CLUSTERED BY (col_name, col_name, …)]<br> [SORTED BY (col_name [ASC|DESC], …)] INTO num_buckets BUCKETS]<br> [ROW FORMAT row_format]<br> [STORED AS file_format]<br> [LOCATION hdfs_path]</p>
</blockquote>
<p><strong><code>说明：</code></strong></p>
<ol>
<li>create table创建一个指定名字的表，如果相同名字的表已经存在，则抛出异常；用户可以用if not exists选项来忽略这个异常。</li>
<li>external 关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径（location）.</li>
</ol>
<ul>
<li>hive创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</li>
</ul>
<p>示例：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建外部表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> student_ext(Sno <span class="built_in">int</span>,Sname <span class="keyword">string</span>,Sex <span class="keyword">string</span>,Sage <span class="built_in">int</span>,Sdept <span class="keyword">string</span>)<span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span> location <span class="string">'/home/hadoop/hivedata/'</span>;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/hivedata/students.txt'</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> student_ext;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li><p>like允许用户复制现有的表结构，但是不复制数据。<br>CREATE [EXTERNAL] TABLE [IF NOT EXISTS] [db_name.]table_name LIKE existing_table;<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--like复制表结构</span><br><span class="line">create table student_tmp like student;</span><br></pre></td></tr></table></figure>
</li>
<li><p>row format delimited（指定文件数据分隔符）</p>
<p>[FIELDS TERMINATED BY char]<br>[COLLECTION ITEMS TERMINATED BY char]<br>[MAP KEYS TERMINATED BY char]<br>[LINES TERMINATED BY char] | SERDE serde_name<br>[WITH SERDEPROPERTIES<br>(property_name=property_value, property_name=property_value,…)]</p>
</li>
</ol>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">创建表，指明分隔符为&apos;,&apos;</span><br><span class="line">create table student(Sno int,Sname string,Sex string,Sage int,Sdept string)row format delimited fields terminated by &apos;,&apos;stored as textfile;</span><br><span class="line"></span><br><span class="line">--创建一个数据类型有集合的表；指定字段分隔符为&apos;;&apos;,集合的分隔符为&apos;,&apos;</span><br><span class="line">create table t_collection (id int,name string)row format delimited fields terminated by &apos;;&apos; collection items terminated by &apos;,&apos;;</span><br><span class="line">load data local inpath &apos;/home/hadoop/hivedata/t_collection.txt&apos; overwrite into table t_collection;</span><br><span class="line">select * from t_collection;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>hive 建表的时候默认的分割符是’\001’，若在建表的时候没有指明分隔符，load 文件的时候文件的分隔符需要是’\001’；若文件分隔符不是’001’，程序不会报错，但表查询的结果会全部为’null’；</li>
<li>用 vi 编辑器 Ctrl+v 然后 Ctrl+a 即可输入’\001’ ———–&gt; ^A</li>
<li>SerDe 是 Serialize/Deserilize 的简称，目的是用于序列化和反序列化。</li>
<li>Hive 读取文件机制： 首先调用 InputFormat（默认 TextInputFormat）， 返回一条一条记录（默认是一行对应一条记录）。然后调用 SerDe （默认 LazySimpleSerDe）的 Deserializer，将一条记录切分为各个字段（ 默认’\001’）。</li>
<li>Hive 写文件机制： 将 Row 写入文件时，主要调用 OutputFormat、 SerDe 的Seriliazer，顺序与读取相反。</li>
<li>可通过 desc formatted 表名； 进行相关信息查看。</li>
<li>当我们的数据格式比较特殊的时候，可以自定义 SerDe。</li>
</ul>
<ol start="5">
<li>partitioned by（分区）</li>
</ol>
<ul>
<li>在 hive Select 查询中一般会扫描整个表内容，会消耗很多时间做没必要的工作。有时候只需要扫描表中关心的一部分数据，因此建表时引入了 partition 分区概念。</li>
<li>分区表指的是在创建表时指定的 partition 的分区空间。 一个表可以拥有一个或者多个分区，每个分区以文件夹的形式单独存在表文件夹的目录下。表和列名不区分大小写。分区是以字段的形式在表结构中存在，通过 describe table 命令可以查看到字段存在，但是该字段不存放实际的数据内容，仅仅是分区的表示。</li>
</ul>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">分区建表分为2种，一种是单分区，也就是说在表文件夹目录下只有一级文件夹目录。另外一种是多分区，表文件夹下出现多文件夹嵌套模式。</span><br><span class="line">单分区建表语句：</span><br><span class="line">create table day_table (id int, content string) partitioned by (dt string);单分区表，按天分区，在表结构中存在id，content，dt三列。(数据文件中只需有表定义的字段)</span><br><span class="line">create table day_table (id int, content string) partitioned by (dt string);</span><br><span class="line">load data local inpath &apos;/home/hadoop/hivedata/day_table.txt&apos; overwrite into table day_table partition(dt=&apos;2018-03-10&apos;);</span><br><span class="line">select *from day_table;</span><br><span class="line"></span><br><span class="line">双分区建表语句：</span><br><span class="line">create table day_hour_table (id int, content string) partitioned by (dt string, hour string);双分区表，按天和小时分区，在表结构中新增加了dt和hour两列。</span><br><span class="line">create table day_hour_table(id int,name string)partitioned by(dt string,hour string);</span><br><span class="line">load data local inpath &apos;/home/hadoop/hivedata/day_hour_table.txt&apos; overwrite into table day_hour_table partition(dt=&apos;2018-03-10&apos;,hour=&apos;21&apos;);</span><br><span class="line">select * from day_hour_table;</span><br></pre></td></tr></table></figure></p>
<ol start="6">
<li>stored as sequencefile |textfile | rcfile</li>
</ol>
<ul>
<li>如果文件数据是纯文本，可以使用 STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE。</li>
<li>TEXTFILE 是默认的文件格式， 使用 DELIMITED 子句来读取分隔的文件。</li>
</ul>
<ol start="7">
<li>clustered by into num_buckets buckets（分桶）</li>
</ol>
<ul>
<li>对于每一个表（ table）或者分， Hive 可以进一步组织成桶，也就是说桶是更为细粒度的数据范围划分。 Hive 也是针对某一列进行桶的组织。 Hive 采用对<code>列值哈希，然后除以桶的个数求余</code>的方式决定该条记录存放在哪个桶当中。</li>
<li>把表（或者分区）组织成桶（ Bucket）有两个理由：<ul>
<li>获得更高的查询处理效率。桶为表加上了额外的结构， Hive 在处理有些查询时能利用这个结构。具体而言，连接两个在（包含连接列的）相同列上划分了桶的表，可以使用 Map 端连接 （ Map-side join）高效的实现。比如 JOIN 操作。对于 JOIN 操作两个表有一个相同的列，如果对这两个表都进行了桶操作。那么将保存相同列值的桶进行 JOIN 操作就可以，可以大大较少 JOIN 的数据量。</li>
<li>使取样（ sampling）更高效。在处理大规模数据集时，在开发和修改查询的阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便。</li>
</ul>
</li>
</ul>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--创建分桶表</span><br><span class="line">drop table stu_buck;</span><br><span class="line">create table stu_buck(Sno int,Sname string,Sex string,Sage int,Sdept string)</span><br><span class="line">clustered by(Sno)</span><br><span class="line">sorted by(Sno desc)</span><br><span class="line">into 4 buckets</span><br><span class="line">row format delimited</span><br><span class="line">fields terminated by &apos;,&apos;;</span><br><span class="line">--分桶表数据导入</span><br><span class="line">insert overwrite table stu_buck select * from student cluster by(Sno);</span><br><span class="line">--分桶、排序等查询：cluster by 、sort by、distribute by</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-修改表"><a href="#1-2-修改表" class="headerlink" title="1.2 修改表"></a>1.2 修改表</h3><p><strong><code>增加分区：</code></strong><br>ALTER TABLE table_name ADD PARTITION (dt=’20170101’) location ‘/user/hadoop/warehouse/table_name/dt=20170101’; //一次添加一个分区</p>
<p>ALTER TABLE table_name ADD PARTITION (dt=’2008-08-08’, country=’us’) location<br>‘/path/to/us/part080808’ PARTITION (dt=’2008-08-09’, country=’us’) location<br>‘/path/to/us/part080809’; //一次添加多个分区</p>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--增加分区</span><br><span class="line">--执行添加分区时   /t_parti文件夹下的数据不会被移动。并且没有分区目录dt=2008-08-08</span><br><span class="line">alter table t_partition add partition (dt=&apos;2018-03-11&apos;) location &apos;hdfs://node-1:9000//t_parti&apos;;</span><br></pre></td></tr></table></figure></p>
<p><strong><code>删除分区：</code></strong><br>ALTER TABLE table_name DROP IF EXISTS PARTITION (dt=’2008-08-08’);<br>ALTER TABLE table_name DROP IF EXISTS PARTITION (dt=’2008-08-08’, country=’us’);<br>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--删除分区</span><br><span class="line">--执行删除分区时/t_parti下的数据会被删除并且连同/t_parti文件夹也会被删除</span><br><span class="line">alter table t_partition drop partition (dt=&apos;2018-03-11&apos;);</span><br><span class="line">--注意区别于load data时候添加分区:会移动数据 会创建分区目录</span><br></pre></td></tr></table></figure></p>
<p><strong><code>修改分区：</code></strong><br>ALTER TABLE table_name PARTITION (dt=’2008-08-08’) RENAME TO PARTITION (dt=’20080808’);</p>
<p><strong><code>添加列:</code></strong><br>ALTER TABLE table_name ADD|REPLACE COLUMNS (col_name STRING);</p>
<ul>
<li>注： ADD 是代表新增一个字段， 新增字段位置在所有列后面(partition 列前),REPLACE 则是表示替换表中所有字段。</li>
</ul>
<p><strong><code>修改列:</code></strong><br>test_change (a int, b int, c int);<br>ALTER TABLE test_change CHANGE a a1 INT; //修改 a 字段名</p>
<p>// will change column a’s name to a1, a’s data type to string, and put it after column b. The new table’s structure is: b int, a1 string, c int<br>ALTER TABLE test_change CHANGE a a1 STRING AFTER b;</p>
<p>// will change column b’s name to b1, and put it as the first column. The new table’s structure is: b1 int, a ints, c int<br>ALTER TABLE test_change CHANGE b b1 INT FIRST;</p>
<p><strong><code>表重命名:</code></strong><br>ALTER TABLE table_name RENAME TO new_table_name</p>
<h3 id="1-3-显示命令"><a href="#1-3-显示命令" class="headerlink" title="1.3 显示命令"></a>1.3 显示命令</h3><ul>
<li><p>显示当前数据库所有表<br>show tables;</p>
</li>
<li><p>显示所有数据库<br>show databases |schemas;</p>
</li>
<li><p>显示表分区信息，不是分区表执行报错<br>show partitions table_name;</p>
</li>
<li><p>显示当前版本 hive 支持的所有方法<br>show functions;</p>
</li>
<li><p>查看表信息<br>desc extended table_name;</p>
</li>
<li><p>查看表信息（格式化美观）<br>desc formatted table_name;</p>
</li>
<li><p>查看数据库相关信息<br>describe database database_name;</p>
</li>
</ul>
<h2 id="2-DML操作"><a href="#2-DML操作" class="headerlink" title="2. DML操作"></a>2. DML操作</h2><h3 id="2-1-LOAD"><a href="#2-1-LOAD" class="headerlink" title="2.1 LOAD"></a>2.1 LOAD</h3><ul>
<li>在将数据加载到表中时， Hive 不会进行任何转换。 加载操作是将数据文件移动到与 Hive表对应的位置的纯复制/移动操作。<br><code>语法结构:</code><br>LOAD DATA [LOCAL] INPATH ‘filepath’ [OVERWRITE] INTO<br>TABLE tablename [PARTITION (partcol1=val1, partcol2=val2 …)]<br>示例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--从本地文件系统中加载数据到hive表中，使用overwrite，则目标表中的内容会被删除，将从指定路径文件中加载</span><br><span class="line">load data local inpath &apos;/home/hadoop/hivedata/students.txt&apos; overwrite into table student;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong><code>说明：</code></strong></p>
<ol>
<li>filepath</li>
</ol>
<ul>
<li>相对路径，例如： project/data1</li>
<li>绝对路径，例如： /user/hive/project/data1</li>
<li>完整 URI， 例如： hdfs://namenode:9000/user/hive/project/data1</li>
<li>filepath 可以引用一个文件（在这种情况下， Hive 将文件移动到表中），或者它可以是一个目录（在这种情况下， Hive 将把该目录中的所有文件移动到表中）。</li>
</ul>
<ol start="2">
<li>LOCAL</li>
</ol>
<ul>
<li>如果指定了 LOCAL， load 命令将在本地文件系统中查找文件路径。</li>
<li>load 命令会将 filepath 中的文件复制到目标文件系统中。目标文件系统由表的位置属性决定。被复制的数据文件移动到表的数据对应的位置。</li>
<li>如果没有指定 LOCAL 关键字，如果 filepath 指向的是一个完整的 URI， hive会直接使用这个 URI。 否则：如果没有指定 schema 或者 authority， Hive 会使用在 hadoop 配置文件中定义的 schema 和 authority， fs.default.name 指定了Namenode 的 URI。</li>
</ul>
<ol start="3">
<li>OVERWRITE</li>
</ol>
<ul>
<li>如果使用了 OVERWRITE 关键字，则目标表（或者分区）中的内容会被删除，然后再将 filepath 指向的文件/目录中的内容添加到表/分区中。</li>
<li>如果目标表（分区）已经有一个文件，并且文件名和 filepath 中的文件名冲突，那么现有的文件会被新文件所替代。</li>
</ul>
<h3 id="2-2-Insert"><a href="#2-2-Insert" class="headerlink" title="2.2 Insert"></a>2.2 Insert</h3><ul>
<li><p>Hive 中 insert 主要是结合 select 查询语句使用， 将查询结果插入到表中，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite table stu_buck</span><br><span class="line">select * from student cluster by(Sno);</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要保证查询结果列的数目和需要插入数据表格的列数目一致.</p>
</li>
<li>如果查询出来的数据类型和插入表格对应的列数据类型不一致，将会进行转换，但是不能保证转换一定成功，转换失败的数据将会为 NULL。</li>
<li>可以将一个表查询出来的数据插入到原表中, 结果相当于自我复制了一份数据。</li>
</ul>
<p><code>Multi Inserts 多重插入:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table source_table (id int, name string) row format delimited fields terminated by &apos;,&apos;;</span><br><span class="line">create table test_insert1 (id int) row format delimited fields terminated by &apos;,&apos;;</span><br><span class="line">create table test_insert2 (name string) row format delimited fields terminated by &apos;,&apos;;</span><br><span class="line"></span><br><span class="line">from source_table                     </span><br><span class="line">insert overwrite table test_insert1 </span><br><span class="line">select id</span><br><span class="line">insert overwrite table test_insert2</span><br><span class="line">select name;</span><br></pre></td></tr></table></figure>
<p><code>动态分区插入:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#是否开启动态分区功能，默认false关闭。</span><br><span class="line">set hive.exec.dynamic.partition=true;    </span><br><span class="line"> </span><br><span class="line">#动态分区的模式，默认strict，表示必须指定至少一个分区为静态分区，nonstrict模式表示允许所有的分区字段都可以使用动态分区。</span><br><span class="line">set hive.exec.dynamic.partition.mode=nonstrict;  </span><br><span class="line"></span><br><span class="line">需求：</span><br><span class="line">将dynamic_partition_table中的数据按照时间(day)，插入到目标表d_p_t的相应分区中。</span><br><span class="line">原始表：</span><br><span class="line">create table dynamic_partition_table(day string,ip string)row format delimited fields terminated by &quot;,&quot;; </span><br><span class="line"></span><br><span class="line">load data local inpath &apos;/root/hivedata/dynamic_partition_table.txt&apos; into table dynamic_partition_table;</span><br><span class="line">2018-02-10,ip1</span><br><span class="line">2018-02-10,ip2</span><br><span class="line">2018-03-14,ip3</span><br><span class="line">2018-03-14,ip4</span><br><span class="line">2018-03-15,ip1</span><br><span class="line">2018-03-15,ip2</span><br><span class="line"></span><br><span class="line">目标表：</span><br><span class="line">create table d_p_t(ip string) partitioned by (month string,day string);</span><br><span class="line"></span><br><span class="line">动态插入：</span><br><span class="line">insert overwrite table d_p_t partition (month,day) </span><br><span class="line">select ip,substr(day,1,7) as month,day </span><br><span class="line">from dynamic_partition_table;</span><br></pre></td></tr></table></figure>
<ul>
<li>动态分区是通过位置来对应分区值的。 原始表 select 出来的值和输出 partition的值的关系仅仅是通过位置来确定的，和名字并没有关系。</li>
</ul>
<p><strong><code>导出表数据</code></strong><br>语法结构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE [<span class="keyword">LOCAL</span>] <span class="keyword">DIRECTORY</span> directory1 <span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ...</span><br><span class="line">multiple inserts:</span><br><span class="line"><span class="keyword">FROM</span> from_statement</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE [<span class="keyword">LOCAL</span>] <span class="keyword">DIRECTORY</span> directory1 select_statement1</span><br><span class="line">[<span class="keyword">INSERT</span> OVERWRITE [<span class="keyword">LOCAL</span>] <span class="keyword">DIRECTORY</span> directory2 select_statement2] ...</span><br></pre></td></tr></table></figure></p>
<p>数据写入到文件系统时进行文本序列化，且每列用^A 来区分， \n 为换行符。</p>
<h3 id="2-3-Select"><a href="#2-3-Select" class="headerlink" title="2.3 Select"></a>2.3 Select</h3><ul>
<li>基本的 Select 操作<ul>
<li>语法结构<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [ALL | <span class="keyword">DISTINCT</span>] select_expr, select_expr, ...</span><br><span class="line"><span class="keyword">FROM</span> table_reference</span><br><span class="line"><span class="keyword">JOIN</span> table_other <span class="keyword">ON</span> expr</span><br><span class="line">[<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> col_list [<span class="keyword">HAVING</span> condition]]</span><br><span class="line">[CLUSTER <span class="keyword">BY</span> col_list</span><br><span class="line">| [<span class="keyword">DISTRIBUTE</span> <span class="keyword">BY</span> col_list][<span class="keyword">SORT</span> <span class="keyword">BY</span>| <span class="keyword">ORDER</span> <span class="keyword">BY</span> col_list]</span><br><span class="line">[<span class="keyword">LIMIT</span> <span class="built_in">number</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong><code>说明：</code></strong></p>
<ol>
<li>order by 会对输入做全局排序，因此只有一个 reducer，会导致当输入规模较大时，<br>需要较长的计算时间。</li>
<li>sort by 不是全局排序，其在数据进入 reducer 前完成排序。因此，如果用 sort by 进行排序，并且设置 mapred.reduce.tasks&gt;1，则 sort by 只保证每个 reducer 的输出有序，不保证全局有序。</li>
<li>distribute by(字段)根据指定字段将数据分到不同的 reducer， 分发算法是 hash 散列。</li>
<li>Cluster by(字段) 除了具有 Distribute by 的功能外，还会对该字段进行排序。<br><code>如果 distribute 和 sort 的字段是同一个时，此时， cluster by = distribute by + sort by</code></li>
</ol>
<h2 id="3-Hive-join"><a href="#3-Hive-join" class="headerlink" title="3. Hive join"></a>3. Hive join</h2><ul>
<li>Hive 中除了支持和传统数据库中一样的内关联、左关联、右关联、全关联，还支持 <code>LEFT SEMI JOIN 和 CROSS JOIN</code>， 但这两种 JOIN 类型也可以用前面的代替。</li>
<li><code>Hive 支持等值连接（ a.id = b.id） ,不支持非等值(a.id&gt;b.id)的连接</code>，因为非等值连接非常难转化到 map/reduce 任务。 另外， Hive 支持多 2 个以上表之间的 join。</li>
<li>写 join 查询时，需要注意几个关键点：</li>
</ul>
<ol>
<li>join 时，每次 map/reduce 任务的逻辑：<ul>
<li>reducer 会缓存 join 序列中除了最后一个表的所有表的记录，再通过最后一个表将结果序列化到文件系统。这一实现有助于在 reduce 端减少内存的使用量。实践中，应该把最大的那个表写在最后（否则会因为缓存浪费大量内存）。</li>
</ul>
</li>
<li>LEFT， RIGHT 和 FULL OUTER 关键字用于处理 join 中空记录的情况<ul>
<li>SELECT a.val, b.val FROM a LEFT OUTER JOIN b ON (a.key=b.key)</li>
<li>对应所有 a 表中的记录都有一条记录输出。输出的结果应该是 a.val, b.val，当a.key=b.key 时，而当 b.key 中找不到等值的 a.key 记录时也会输出:</li>
<li>a.val, NULL</li>
<li>所以 a 表中的所有记录都被保留了；</li>
<li>“a RIGHT OUTER JOIN b” 会保留所有 b 表的记录。</li>
</ul>
</li>
<li>Join 发生在 WHERE 子句之前。</li>
</ol>
<ul>
<li>如果你想限制 join 的输出，应该在 WHERE 子句中写过滤条件——或是在 join 子句中写。这里面一个容易混淆的问题是表分区的情况：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.val, b.val FROM a</span><br><span class="line">LEFT OUTER JOIN b ON (a.key=b.key)</span><br><span class="line">WHERE a.ds=&apos;2009-07-07&apos; AND b.ds=&apos;2009-07-07&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>这会 join a 表到 b 表（ OUTER JOIN），列出 a.val 和 b.val 的记录。 WHERE 从句中可以使用其他列作为过滤条件。但是，如前所述，如果 b 表中找不到对应 a 表的记录， b 表的所有列都会列出 NULL， 包括 ds 列。也就是说， join 会过滤 b 表中不能找到匹配 a 表 join key 的所有记录。这样的话， LEFT OUTER 就使得查询结果与 WHERE 子句无关了。解决的办法是在 OUTER JOIN 时使用以下语法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.val, b.val FROM a LEFT OUTER JOIN b</span><br><span class="line">ON (a.key=b.key AND</span><br><span class="line">b.ds=&apos;2009-07-07&apos; AND</span><br><span class="line">a.ds=&apos;2009-07-07&apos;)</span><br></pre></td></tr></table></figure>
<ul>
<li>这一查询的结果是预先在 join 阶段过滤过的，所以不会存在上述问题。这一逻辑也<br>可以应用于 RIGHT 和 FULL 类型的 join 中。</li>
</ul>
<ol start="4">
<li>Join 是不能交换位置的。</li>
</ol>
<ul>
<li>无论是 LEFT 还是 RIGHT join，都是左连接的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.val1, a.val2, b.val, c.val</span><br><span class="line">FROM a</span><br><span class="line">JOIN b ON (a.key = b.key)</span><br><span class="line">LEFT OUTER JOIN c ON (a.key = c.key)</span><br></pre></td></tr></table></figure>
<ul>
<li>先 join a 表到 b 表，丢弃掉所有 join key 中不匹配的记录，然后用这一中间结果和 c 表做 join。</li>
</ul>
<h2 id="4-hive交互式命令"><a href="#4-hive交互式命令" class="headerlink" title="4. hive交互式命令"></a>4. hive交互式命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@node-1 ~]$ hive extended -e</span><br><span class="line">usage: hive</span><br><span class="line"> -d,--define &lt;key=value&gt;          Variable subsitution to apply to hive</span><br><span class="line">                                  commands. e.g. -d A=B or --define A=B</span><br><span class="line">    --database &lt;databasename&gt;     Specify the database to use</span><br><span class="line"> -e &lt;quoted-query-string&gt;         SQL from command line</span><br><span class="line"> -f &lt;filename&gt;                    SQL from files</span><br><span class="line"> -H,--help                        Print help information</span><br><span class="line">    --hiveconf &lt;property=value&gt;   Use value for given property</span><br><span class="line">    --hivevar &lt;key=value&gt;         Variable subsitution to apply to hive</span><br><span class="line">                                  commands. e.g. --hivevar A=B</span><br><span class="line"> -i &lt;filename&gt;                    Initialization SQL file</span><br><span class="line"> -S,--silent                      Silent mode in interactive shell</span><br><span class="line"> -v,--verbose                     Verbose mode (echo executed SQL to the</span><br><span class="line">                                  console)</span><br></pre></td></tr></table></figure>
<p>常用示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* bin/hive -e &lt;quoted-query-string&gt;</span><br><span class="line">eg:</span><br><span class="line">	bin/hive -e &quot;select * from mars.student ;&quot;</span><br><span class="line">* bin/hive -f &lt;filename&gt;</span><br><span class="line">eg:</span><br><span class="line">	$ touch hivef.sql</span><br><span class="line">		select * from mars.student ;</span><br><span class="line">	$ bin/hive -f /opt/datas/hivef.sql </span><br><span class="line">	$ bin/hive -f /opt/datas/hivef.sql &gt; /opt/datas/hivef-res.txt</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>在hive cli命令窗口中如何查看hdfs文件系统<br>hive (default)&gt; dfs -ls / ;</p>
</li>
<li><p>在hive cli命令窗口中如何查看本地文件系统<br>hive (default)&gt; !ls /opt/datas </p>
</li>
</ul>
<h1 id="Hive函数"><a href="#Hive函数" class="headerlink" title="Hive函数"></a>Hive函数</h1><h2 id="1-Hive自定义函数和Transform"><a href="#1-Hive自定义函数和Transform" class="headerlink" title="1. Hive自定义函数和Transform"></a>1. Hive自定义函数和Transform</h2><ul>
<li>当 Hive 提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（ UDF： user-defined function）。</li>
</ul>
<h3 id="1-1-UDF开发示例"><a href="#1-1-UDF开发示例" class="headerlink" title="1.1 UDF开发示例"></a>1.1 UDF开发示例</h3><ul>
<li>新建 JAVA maven 项目</li>
<li>添加 hive-exec-1.2.1.jar 和 hadoop-common-2.7.4.jar 依赖（见参考资料）</li>
</ul>
<ol>
<li>写一个 java 类，继承 UDF，并重载 evaluate 方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package cn.itcast.bigdata.udf</span><br><span class="line">import org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line">import org.apache.hadoop.io.Text;</span><br><span class="line"></span><br><span class="line">public class Lower extends UDF&#123;</span><br><span class="line">	public Text evaluate(Text s)&#123;</span><br><span class="line">		if(s==null)&#123;return null;&#125;</span><br><span class="line">		return new Text(s.toString().toLowerCase());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>打成 jar 包上传到服务器</li>
<li>将 jar 包添加到 hive 的 classpath<br>hive&gt;add JAR /home/hadoop/udf.jar;</li>
<li>创建临时函数与开发好的 java class 关联</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create temporary function tolowercase as &apos;cn.itcast.bigdata.udf.ToProvince&apos;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>即可在 hql 中使用自定义的函数 tolowercase ip<br>Select tolowercase(name),age from t_test;</li>
</ol>
<h3 id="1-2-Transform实现"><a href="#1-2-Transform实现" class="headerlink" title="1.2 Transform实现"></a>1.2 Transform实现</h3><ul>
<li>Hive 的 TRANSFORM 关键字<code>提供了在 SQL 中调用自写脚本的功能</code></li>
<li>适合实现 Hive 中没有的功能又不想写 UDF 的情况</li>
<li>使用示例 1： 下面这句 sql 就是借用了 weekday_mapper.py 对数据进行了处理</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add FILE weekday_mapper.py;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> u_data_new</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	TRANSFORM (movieid , rate, timestring,uid)</span><br><span class="line">	<span class="keyword">USING</span> <span class="string">'python weekday_mapper.py'</span></span><br><span class="line">	<span class="keyword">AS</span> (movieid, rating, <span class="keyword">weekday</span>,userid)</span><br><span class="line"><span class="keyword">FROM</span> t_rating;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中weekday_mapper.py内容如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">	line = line.strip()</span><br><span class="line">	movieid, rating, unixtime,userid = line.split(<span class="string">'\t'</span>)</span><br><span class="line">	weekday = datetime.datetime.fromtimestamp(float(unixtime)).isoweekday()</span><br><span class="line">	<span class="keyword">print</span> <span class="string">'\t'</span>.join([movieid, rating, str(weekday),userid])</span><br></pre></td></tr></table></figure>
<h2 id="2-Hive-特殊分隔符处理"><a href="#2-Hive-特殊分隔符处理" class="headerlink" title="2. Hive 特殊分隔符处理"></a>2. Hive 特殊分隔符处理</h2><p><strong><code>hive 读取数据的机制：</code></strong></p>
<ul>
<li>首先用 InputFormat&lt;默认是： org.apache.hadoop.mapred.TextInputFormat &gt;的一个具体实现类读入文件数据，返回一条一条的记录（可以是行，或者是你逻辑中的“行”）</li>
<li>然后利用 SerDe&lt;默认： org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&gt;的一个具体实现类，对上面返回的一条一条的记录进行字段切割。</li>
<li><p>Hive 对文件中字段的分隔符默认情况下只支持单字节分隔符，如果数据文件中的分隔符是多字符的，如下所示：<br>01||zhangsan<br>02||lisi</p>
</li>
<li><p>可用使用 RegexSerDe 通过正则表达式来抽取字段</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table t_bi_reg;</span><br><span class="line">create table t_bi_reg(id string,name string)</span><br><span class="line">row format serde &apos;org.apache.hadoop.hive.serde2.RegexSerDe&apos;</span><br><span class="line">with serdeproperties(</span><br><span class="line">&apos;input.regex&apos;=&apos;(.*)\\|\\|(.*)&apos;,</span><br><span class="line">&apos;output.format.string&apos;=&apos;%1$s %2$s&apos;</span><br><span class="line">)</span><br><span class="line">stored as textfile;</span><br><span class="line">hive&gt;load data local inpath &apos;/root/hivedata/bi.dat&apos; into table t_bi_reg;</span><br><span class="line">hive&gt;select * from t_bi_reg;</span><br></pre></td></tr></table></figure>
<p>其中：<br>input.regex：输入的正则表达式<br>    表示 || 左右两边任意字符被抽取为一个字段<br>output.format.string：输出的正则表达式<br>    %1$s %2$s 则分别表示表中的第一个字段、第二个地段<br>注意事项：<br>a. 使用 RegexSerDe 类时，所有的字段必须为 string<br>b. input.regex 里面，以一个匹配组，表示一个字段<br>相关代码：链接：<a href="https://pan.baidu.com/s/1_lv2RaZug0ZYMV0BKAwYVg" target="_blank" rel="noopener">https://pan.baidu.com/s/1_lv2RaZug0ZYMV0BKAwYVg</a> 密码：s5kz</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Marsm
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://marsm.top/hive/2018/03/10/hive基本命令（三）/" title="hive基本命令（三）">http://marsm.top/hive/2018/03/10/hive基本命令（三）/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/hive/" rel="tag"><i class="fa fa-tag"></i> hive</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        
          <div class="wp_rating">
            <div id="wpac-rating"></div>
          </div>
        

        

        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/hive/2018/03/09/hive安装与配置（二）/" rel="next" title="hive安装与配置（二）">
                <i class="fa fa-chevron-left"></i> hive安装与配置（二）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/hive/2018/03/16/hive常用字符串函数（四）/" rel="prev" title="hive常用字符串函数(四)">
                hive常用字符串函数(四) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="Marsm">
            
              <p class="site-author-name" itemprop="name">Marsm</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hive基本命令"><span class="nav-number">1.</span> <span class="nav-text">hive基本命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-hive完整DDL"><span class="nav-number">1.1.</span> <span class="nav-text">1. hive完整DDL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1创建表"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1创建表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-修改表"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 修改表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-显示命令"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 显示命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-DML操作"><span class="nav-number">1.2.</span> <span class="nav-text">2. DML操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-LOAD"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 LOAD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Insert"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 Insert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Select"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 Select</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Hive-join"><span class="nav-number">1.3.</span> <span class="nav-text">3. Hive join</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-hive交互式命令"><span class="nav-number">1.4.</span> <span class="nav-text">4. hive交互式命令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hive函数"><span class="nav-number">2.</span> <span class="nav-text">Hive函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Hive自定义函数和Transform"><span class="nav-number">2.1.</span> <span class="nav-text">1. Hive自定义函数和Transform</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-UDF开发示例"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 UDF开发示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Transform实现"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 Transform实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Hive-特殊分隔符处理"><span class="nav-number">2.2.</span> <span class="nav-text">2. Hive 特殊分隔符处理</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Marsm</span>
	<br>
  
    <!--<span class="post-meta-divider">|</span>-->
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">全站字数&#58;</span>
    
    <span title="全站字数">80.6k</span>
  
</div>










        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'kgmQivNAXWLoHERRMUGT3q0l-gzGzoHsz',
        appKey: 'TIQYAjdznmPurJpulmEA7ygX',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("kgmQivNAXWLoHERRMUGT3q0l-gzGzoHsz", "TIQYAjdznmPurJpulmEA7ygX");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  <script type="text/javascript">
  wpac_init = window.wpac_init || [];
  wpac_init.push({widget: 'Rating', id: ,
    el: 'wpac-rating',
    color: 'fc6423'
  });
  (function() {
    if ('WIDGETPACK_LOADED' in window) return;
    WIDGETPACK_LOADED = true;
    var mc = document.createElement('script');
    mc.type = 'text/javascript';
    mc.async = true;
    mc.src = '//embed.widgetpack.com/widget.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
  })();
  </script>


  

  

  

</body>
</html>
